name: "ðŸ”„ Sync all branches with main"

on:
  workflow_dispatch:

jobs:
  sync_branches:
    runs-on: ubuntu-latest
    name: "ðŸ”„ Sync branches with main"

    env:
      EMAIL: ${{ secrets.GH_EMAIL }}
      NAME: ${{ secrets.GH_USERNAME }}
      TOKEN: ${{ secrets.TOKEN }}
      BRANCH_BASE_NAME: proxyip
      BRANCH_COUNT: 200

    steps:
      - name: ðŸ›  Set Git config
        run: |
          git config --global user.email "${{ env.EMAIL }}"
          git config --global user.name "${{ env.NAME }}"

      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.TOKEN }}
          fetch-depth: 0

      - name: ðŸ”„ Sync all branches with main
        run: |
          # Ensure we have full branch data
          git fetch --all

          # Ensure main exists and up to date
          git checkout main || git checkout -b main
          git pull origin main || true

          for ((i=1; i<=${BRANCH_COUNT}; i++)); do
            BR="${BRANCH_BASE_NAME}${i}"

            if git show-ref --verify --quiet refs/heads/$BR; then
              echo "âž¡ Syncing $BR"

              git checkout $BR

              # Merge but never break the workflow
              git merge main --no-edit || true

              git push origin $BR || true

              git checkout main
            else
              echo "âŒ Branch $BR does NOT exist, skipping."
            fi
          done
